{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-12">
    <!-- Header Section -->
    <div class="flex flex-col items-center justify-center border-b noir-border pt-6 pb-6 space-y-4 text-center">
        <div class="space-y-1">
            <h1 class="text-4xl font-bold tracking-tighter mono-display uppercase">Analytics_Engine</h1>
            <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Protocol: Subject_Performance_Audit</p>
        </div>
    </div>

    <!-- Core Metrics Matrix -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="noir-border bg-[var(--bg-alt)] space-y-2 border-l-4 border-l-accent">
            <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Total_Temporal_Focus</span>
            <p class="text-4xl font-bold mono-display text-accent">{{ total_minutes | format_minutes }}</p>
        </div>

        <div class="noir-border bg-[var(--bg-alt)] space-y-2 border-l-4 border-l-purple-600">
            <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Current_Cycle_Log (WEEK)</span>
            <p class="text-4xl font-bold mono-display">{{ weekly_minutes | format_minutes }}</p>
        </div>

        <div class="noir-border bg-[var(--bg-alt)] space-y-2 border-l-4 border-l-green-600">
            <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Successful_Poms</span>
            <p class="text-4xl font-bold mono-display">{{ total_sessions }} <span class="text-xs opacity-30">RECORDS</span></p>
        </div>
    </div>

    <!-- Social Metrics -->
    <div class="space-y-6">
        <h2 class="text-xl font-bold mono-display uppercase tracking-widest">Sync_Network_Data</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="noir-border bg-[var(--bg-alt)] space-y-1 border-l-4 border-l-blue-600">
                 <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Established_Links</span>
                 <p class="text-3xl font-bold mono-display">{{ sync_sessions_count }}</p>
            </div>
            <div class="noir-border bg-[var(--bg-alt)] space-y-1 border-l-4 border-l-cyan-600">
                 <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Synced_Temporal_Data</span>
                 <p class="text-3xl font-bold mono-display text-accent">{{ sync_minutes | format_minutes }}</p>
            </div>
            <div class="noir-border bg-[var(--bg-alt)] space-y-1 border-l-4 border-l-pink-600">
                 <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Primary_Sync_Partner</span>
                 <p class="text-xl font-bold mono-display truncate">
                    {% if top_partner %}
                        @{{ top_partner.username }}
                    {% else %}
                        <span class="opacity-20 text-sm italic">NO_LINK_DATA</span>
                    {% endif %}
                 </p>
            </div>
        </div>
    </div>

    <!-- Activity Matrix (Heatmap) -->
    <div class="space-y-8">
        <div class="noir-border bg-[var(--bg-alt)] space-y-6">
            <h2 class="text-lg font-bold mono-display uppercase tracking-widest border-b noir-border pb-2">Study_Temporal_Density ({{ current_year }})</h2>
            <div class="overflow-x-auto">
                <div id="heatmap-container" class="flex gap-1 py-4" style="min-width: max-content;"></div>
            </div>
        </div>

        <div class="noir-border bg-[var(--bg-alt)] space-y-6">
            <h2 class="text-lg font-bold mono-display uppercase tracking-widest border-b noir-border pb-2">Habit_Consistency_Grid ({{ current_year }})</h2>
            <div class="overflow-x-auto">
                <div id="habit-heatmap-container" class="flex gap-1 py-4" style="min-width: max-content;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const currentYear = {{ current_year }};
        const studyData = {{ heatmap_data | tojson }};
        const habitData = {{ habit_heatmap_data | tojson }};

        renderHeatmap('heatmap-container', studyData, new Date(currentYear, 0, 1), new Date(currentYear, 11, 31), true);
        renderHeatmap('habit-heatmap-container', habitData, new Date(currentYear, 0, 1), new Date(currentYear, 11, 31), false);

        function renderHeatmap(containerId, data, startDate, endDate, isTemporal) {
            const container = document.getElementById(containerId);
            let current = new Date(startDate);
            let currentColumn = document.createElement('div');
            currentColumn.className = 'flex flex-col gap-1';
            
            const startDay = current.getDay(); 
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'w-2.5 h-2.5';
                currentColumn.appendChild(emptyCell);
            }

            while (current <= endDate) {
                if (current.getDay() === 0 && currentColumn.children.length > 0) {
                    container.appendChild(currentColumn);
                    currentColumn = document.createElement('div');
                    currentColumn.className = 'flex flex-col gap-1';
                }
                
                const dateStr = current.toISOString().split('T')[0];
                const val = data[dateStr] || 0;
                
                const cell = document.createElement('div');
                cell.className = `w-2.5 h-2.5 noir-border transition-colors duration-100`;
                
                if (val > 0) {
                    cell.style.backgroundColor = 'var(--accent-color)';
                    if (isTemporal) {
                        cell.style.opacity = val < 30 ? '0.2' : val < 60 ? '0.5' : val < 120 ? '0.8' : '1.0';
                    } else {
                        cell.style.opacity = val === 1 ? '0.2' : val <= 3 ? '0.5' : val <= 5 ? '0.8' : '1.0';
                    }
                }
                
                cell.title = `${dateStr}: ${val}`;
                currentColumn.appendChild(cell);
                current.setDate(current.getDate() + 1);
            }
            if (currentColumn.children.length > 0) container.appendChild(currentColumn);
        }
    });
</script>
{% endblock %}
