{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-12">
    <!-- Header Section -->
    <div class="flex flex-col items-center justify-center border-b noir-border pt-6 pb-6 space-y-4 text-center">
        <div class="space-y-1">
            <h1 class="text-4xl font-bold tracking-tighter mono-display uppercase">Habit_Tracker</h1>
            <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Protocol: Consistency_Optimization</p>
        </div>
    </div>

    <!-- Add Habit Block -->
    <div class="noir-border bg-[var(--bg-alt)]">
        <form hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}' hx-post="{{ url_for('main.add_habit') }}" 
              hx-target="#habit-list-container" 
              hx-on::after-request="this.reset()"
              class="flex gap-6">
            <input type="text" name="title" placeholder="NEW_HABIT_DEFINITION" required
                   class="noir-input flex-1 font-bold">
            <button type="submit" class="noir-button px-12">ENROLL</button>
        </form>
    </div>

    <!-- Habits Matrix -->
    <div class="noir-border bg-[var(--bg-alt)] overflow-x-auto" id="habit-list-container">
        {% include 'partials/habit_list.html' %}
    </div>

    <!-- Yearly Matrix (Heatmap) -->
    <div class="noir-border bg-[var(--bg-alt)] space-y-6">
        <h2 class="text-lg font-bold mono-display uppercase tracking-widest border-b noir-border pb-2">Annual_Performance_Grid ({{ current_year }})</h2>
        <div class="overflow-x-auto">
            <div id="habit-heatmap-container" class="flex gap-1 py-4" style="min-width: max-content;">
                <!-- Grid generated by JS -->
            </div>
        </div>
        <div class="flex items-center gap-4 text-[8px] font-bold uppercase justify-end opacity-50">
            <span>LOW_DENSITY</span>
            <div class="flex gap-1">
                <div class="w-2 h-2 noir-border bg-transparent"></div>
                <div class="w-2 h-2 bg-accent/20"></div>
                <div class="w-2 h-2 bg-accent/50"></div>
                <div class="w-2 h-2 bg-accent/80"></div>
                <div class="w-2 h-2 bg-accent"></div>
            </div>
            <span>HIGH_DENSITY</span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const heatmapData = {{ heatmap_data | tojson }};
        const currentYear = {{ current_year }};
        const container = document.getElementById('habit-heatmap-container');
        
        const startDate = new Date(currentYear, 0, 1);
        const endDate = new Date(currentYear, 11, 31);
        
        let current = new Date(startDate);
        let currentColumn = document.createElement('div');
        currentColumn.className = 'flex flex-col gap-1';
        
        const startDay = current.getDay(); 
        for (let i = 0; i < startDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'w-2.5 h-2.5';
            currentColumn.appendChild(emptyCell);
        }

        while (current <= endDate) {
            if (current.getDay() === 0 && currentColumn.children.length > 0) {
                container.appendChild(currentColumn);
                currentColumn = document.createElement('div');
                currentColumn.className = 'flex flex-col gap-1';
            }
            
            const dateStr = current.toISOString().split('T')[0];
            const count = heatmapData[dateStr] || 0;
            
            const cell = document.createElement('div');
            cell.className = `w-2.5 h-2.5 noir-border transition-colors duration-100`;
            
            if (count > 0) {
                cell.style.backgroundColor = 'var(--accent-color)';
                cell.style.opacity = count === 1 ? '0.2' : count <= 3 ? '0.5' : count <= 5 ? '0.8' : '1.0';
            }
            
            cell.title = `${dateStr}: ${count}`;
            currentColumn.appendChild(cell);
            current.setDate(current.getDate() + 1);
        }
        if (currentColumn.children.length > 0) container.appendChild(currentColumn);
    });
</script>
{% endblock %}
