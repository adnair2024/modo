{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-12">
    <!-- Header Section -->
    <div class="flex flex-col items-center justify-center border-b noir-border pt-6 pb-6 space-y-4 text-center">
        <div class="space-y-1">
            <h1 class="text-4xl font-bold tracking-tighter mono-display uppercase">System_Config</h1>
            <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">PATH: /ROOT/SETTINGS</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-12" x-data="{ vimMode: {{ 'true' if current_user.enable_vim_mode else 'false' }} }">
        
        <!-- Left Column: Core Identity -->
        <div class="md:col-span-2 space-y-16">
            <!-- Profile Hardware -->
            <section class="space-y-8">
                <div class="flex flex-col items-center border-b noir-border border-opacity-10 pt-6 pb-4 text-center">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-accent">Profile_Identity</h2>
                </div>
                
                <div class="space-y-8 pt-4">
                    <div class="flex items-start gap-8">
                        <div class="relative w-32 h-32 noir-border bg-accent/10 flex items-center justify-center overflow-hidden group">
                            {% if current_user.profile_pic_url %}
                                <img src="{{ current_user.profile_pic_url }}" class="w-full h-full object-cover" id="preview-pic" style="object-position: {{ current_user.profile_pic_position or '50% 50%' }}">
                            {% else %}
                                <span class="text-4xl font-bold opacity-20">{{ current_user.username[0].upper() }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="flex-1 space-y-4">
                            <div class="space-y-2">
                                <label class="block text-[10px] font-bold opacity-50 uppercase tracking-widest">Image_Source_URL</label>
                                <input type="url" id="profile-pic-url" value="{{ current_user.profile_pic_url or '' }}" 
                                       class="noir-input w-full text-xs" placeholder="HTTPS://IMG_HOST/ID_01.JPG">
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-2">
                                <div>
                                    <label class="text-[9px] uppercase font-bold opacity-40">AXIS_X</label>
                                    <input type="range" id="pic-x" min="0" max="100" value="50" class="w-full accent-accent">
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold opacity-40">AXIS_Y</label>
                                    <input type="range" id="pic-y" min="0" max="100" value="50" class="w-full accent-accent">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold opacity-50 uppercase tracking-widest">Identity_Statement (BIO)</label>
                        <textarea id="user-bio" maxlength="255" rows="3" class="noir-input w-full text-sm resize-none" placeholder="DECLARE_INTENT_">{{ current_user.bio or '' }}</textarea>
                    </div>
                </div>
            </section>

            <!-- Automation Logic -->
            <section class="space-y-8">
                <div class="flex flex-col items-center border-b noir-border border-opacity-10 pt-6 pb-4 text-center">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-accent">Automation_Protocols</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 pt-4">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between group cursor-pointer" @click="$refs.autoBreak.click()">
                            <span class="text-xs font-bold uppercase tracking-widest">Auto_Break</span>
                            <input type="checkbox" id="auto-break" x-ref="autoBreak" class="accent-accent w-4 h-4" {{ 'checked' if current_user.auto_start_break else '' }}>
                        </div>
                        <div class="flex items-center justify-between group cursor-pointer" @click="$refs.autoFocus.click()">
                            <span class="text-xs font-bold uppercase tracking-widest">Auto_Focus</span>
                            <input type="checkbox" id="auto-focus" x-ref="autoFocus" class="accent-accent w-4 h-4" {{ 'checked' if current_user.auto_start_focus else '' }}>
                        </div>
                        <div class="flex items-center justify-between group cursor-pointer" @click="$refs.autoPriority.click()">
                            <span class="text-xs font-bold uppercase tracking-widest">Auto_Task_Select</span>
                            <input type="checkbox" id="auto-priority" x-ref="autoPriority" class="accent-accent w-4 h-4" {{ 'checked' if current_user.auto_select_priority else '' }}>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-[9px] font-bold opacity-40 uppercase">Focus_Minutes</label>
                            <input type="number" id="focus-duration" value="{{ current_user.focus_duration or 25 }}" class="noir-input w-full text-xs">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[9px] font-bold opacity-40 uppercase">Break_Minutes</label>
                            <input type="number" id="break-duration" value="{{ current_user.break_duration or 5 }}" class="noir-input w-full text-xs">
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Right Column: Visual & Controls -->
        <div class="space-y-16">
            <!-- Appearance / Hardware Color -->
            <section class="space-y-8">
                <div class="flex flex-col items-center border-b noir-border border-opacity-10 pt-6 pb-4 text-center">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-accent">Hardware_Skin</h2>
                </div>
                
                <div class="space-y-8 pt-4">
                    <div>
                        <label class="block text-[10px] font-bold opacity-50 uppercase mb-6 tracking-widest text-center">Signal_Color (ACCENT)</label>
                        <div class="grid grid-cols-4 gap-4">
                            {% for color in ['indigo', 'blue', 'green', 'red', 'purple', 'pink', 'orange'] %}
                            <label class="cursor-pointer">
                                <input type="radio" name="accent_color" value="{{ color }}" class="sr-only peer" {{ 'checked' if (current_user.accent_color or 'indigo') == color else '' }}>
                                <div class="w-full aspect-square bg-{{ color }}-600 peer-checked:ring-4 ring-accent/30 transition-all"></div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="pt-4 space-y-4">
                         <label class="block text-[10px] font-bold opacity-50 uppercase mb-2 tracking-widest text-center">System_Theme</label>
                         <div class="flex flex-col gap-3">
                            <button class="noir-button-outline w-full text-[10px] text-center px-4 py-3 {{ 'bg-accent/10 border-accent' if current_user.theme_preference == 'light' else '' }}" onclick="setTheme('light')">MODE_LIGHT</button>
                            <button class="noir-button-outline w-full text-[10px] text-center px-4 py-3 {{ 'bg-accent/10 border-accent' if current_user.theme_preference == 'dark' else '' }}" onclick="setTheme('dark')">MODE_DARK</button>
                            {% if amoled_unlocked %}
                            <button class="noir-button-outline w-full text-[10px] text-center px-4 py-3 {{ 'bg-accent/10 border-accent' if current_user.theme_preference == 'amoled' else '' }}" onclick="setTheme('amoled')">MODE_AMOLED</button>
                            {% endif %}
                         </div>
                    </div>
                </div>
            </section>

            <!-- Keyboard & System -->
            <section class="space-y-8">
                <div class="flex flex-col items-center border-b noir-border border-opacity-10 pt-6 pb-4 text-center">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-accent">Sys_Access</h2>
                </div>
                <div class="space-y-6 pt-4">
                    <div class="flex items-center justify-between group cursor-pointer" @click="vimMode = !vimMode">
                        <span class="text-xs font-bold uppercase tracking-widest">Enable_Vim_Mode</span>
                        <div :class="vimMode ? 'bg-accent' : 'bg-gray-200 dark:bg-white/10'" class="w-10 h-4 transition-colors"></div>
                        <input type="hidden" id="enable-vim-mode" :value="vimMode">
                    </div>
                    <div class="flex items-center justify-between group cursor-pointer" @click="$refs.showLastSeen.click()">
                        <span class="text-xs font-bold uppercase tracking-widest">Online_Status</span>
                        <input type="checkbox" id="show-last-seen" x-ref="showLastSeen" class="accent-accent" {{ 'checked' if current_user.show_last_seen else '' }}>
                    </div>
                </div>
            </section>

            <!-- Finalize -->
            <button id="save-settings" class="noir-button w-full py-6 text-sm tracking-[0.3em]">COMMIT_CHANGES</button>
        </div>
    </div>
</div>

<input type="hidden" id="profile-pic-position" value="{{ current_user.profile_pic_position or '50% 50%' }}">

<script>
    const saveButton = document.getElementById('save-settings');
    const picUrlInput = document.getElementById('profile-pic-url');
    const picPosInput = document.getElementById('profile-pic-position');
    const previewPic = document.getElementById('preview-pic');
    const sliderX = document.getElementById('pic-x');
    const sliderY = document.getElementById('pic-y');

    if (picPosInput && (sliderX || sliderY)) {
        const [initialX, initialY] = picPosInput.value.split(' ').map(v => parseInt(v) || 50);
        sliderX.value = initialX;
        sliderY.value = initialY;
    }

    const updatePos = () => {
        const posValue = `${sliderX.value}% ${sliderY.value}%`;
        if(previewPic) previewPic.style.objectPosition = posValue;
        picPosInput.value = posValue;
    };

    sliderX.addEventListener('input', updatePos);
    sliderY.addEventListener('input', updatePos);
    
    if (picUrlInput && previewPic) {
        picUrlInput.addEventListener('input', () => { previewPic.src = picUrlInput.value; });
    }

    saveButton.addEventListener('click', () => {
        const settings = {
            profile_pic_url: document.getElementById('profile-pic-url').value,
            profile_pic_position: document.getElementById('profile-pic-position').value,
            bio: document.getElementById('user-bio').value,
            enable_vim_mode: document.getElementById('enable-vim-mode').value === 'true',
            auto_start_break: document.getElementById('auto-break').checked,
            auto_start_focus: document.getElementById('auto-focus').checked,
            auto_select_priority: document.getElementById('auto-priority').checked,
            focus_duration: document.getElementById('focus-duration').value,
            break_duration: document.getElementById('break-duration').value,
            show_last_seen: document.getElementById('show-last-seen').checked,
            accent_color: document.querySelector('input[name="accent_color"]:checked').value
        };

        fetch('/api/update_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(settings)
        }).then(response => {
            if (response.ok) {
                alert('CONFIG_COMMITTED');
                location.reload();
            } else {
                console.error('Failed to save settings:', response.statusText);
                alert('CONFIG_ERROR: ' + response.statusText);
            }
        }).catch(err => {
            console.error('Fetch error:', err);
            alert('SYSTEM_NET_ERROR');
        });
    });

    function setTheme(theme) {
        fetch('/api/update_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({theme: theme})
        }).then(() => { location.reload(); });
    }
</script>
{% endblock %}
