{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto flex flex-col items-center justify-center space-y-16 py-12">
    
    <!-- System Status Header -->
    <div class="w-full noir-border p-4 flex justify-between items-center opacity-60">
        <span class="text-[10px] font-bold uppercase tracking-widest">Sys_Process: Focus_Execution</span>
        <span class="text-[10px] font-bold uppercase tracking-widest">Module: Timer_V.1.0</span>
    </div>

    <!-- The CRT Halftone Aura & Clock -->
    <div class="relative group">
        <!-- CRT Halftone Aura Mask (CSS handled) -->
        <div class="absolute inset-[-100px] crt-aura animate-aura transition-opacity duration-1000 group-hover:opacity-60"></div>
        
        <div class="relative flex flex-col items-center">
            <span id="page-timer-display" class="text-[12rem] leading-none font-bold mono-display text-accent tracking-tighter select-none drop-shadow-[0_0_30px_rgba(var(--accent-rgb),0.3)]">{{ (active_sync_room.focus_duration if active_sync_room else (current_user.focus_duration or 25)) }}:00</span>
            <div id="timer-mode-label" class="text-sm font-bold uppercase tracking-[1em] text-accent opacity-50 ml-[1em]">IDLE_READY</div>
        </div>
    </div>

    <!-- Progress Array: 1x20 Dot Matrix -->
    <div class="dot-matrix-row justify-center py-8">
        {% for i in range(20) %}
            <div class="dot-matrix-dot inactive" data-dot="{{ i }}"></div>
        {% endfor %}
    </div>

    <!-- Hardware Controls -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 w-full">
        <!-- Task Selection -->
        <div class="noir-border bg-[var(--bg-alt)] p-6 space-y-4">
            <div>
                <label class="block text-[10px] font-bold opacity-50 uppercase mb-4 tracking-widest">Target_Execution_Task</label>
                <select id="page-timer-task" class="noir-input w-full font-bold uppercase bg-transparent">
                    <option value="">[NO_SELECTION]</option>
                    {% for task in tasks %}
                        <option value="{{ task.id }}">{{ task.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="page-timer-subtask-container">
                <label class="block text-[10px] font-bold opacity-50 uppercase mb-4 tracking-widest">Active_Subtask</label>
                <select id="page-timer-subtask" class="noir-input w-full font-bold uppercase bg-transparent hidden">
                    <option value="">[NO_SUBTASK_SELECTED]</option>
                </select>
            </div>
        </div>

        <!-- System Controls -->
        <div class="flex items-center justify-center gap-4">
            <button id="page-timer-start" class="noir-button flex-1 py-4 text-sm tracking-widest">EXE_START</button>
            <button id="page-timer-pause" class="noir-button flex-1 py-4 text-sm tracking-widest hidden" style="filter: hue-rotate(45deg);">INT_PAUSE</button>
            <button id="page-timer-reset" class="noir-button-outline flex-1 py-4 text-sm tracking-widest">SYS_RESET</button>
        </div>
    </div>

    <!-- Secondary Controls -->
    <div class="flex gap-4 opacity-50">
        <button id="page-timer-skip" class="text-[10px] font-bold uppercase border-b noir-border hover:text-accent hover:border-accent hidden">Skip_Break_Sequence</button>
        <button id="page-timer-end" class="text-[10px] font-bold uppercase border-b noir-border hover:text-accent hover:border-accent hidden">Terminate_Early</button>
    </div>
</div>

<script>
    // Update Dot Matrix Progress
    document.body.addEventListener('timerTick', (e) => {
        const percent = e.detail.percent; // 0 to 100
        const activeDots = Math.floor(percent / 5); // 20 dots total
        document.querySelectorAll('.dot-matrix-dot').forEach((dot, i) => {
            if (i < activeDots) {
                dot.classList.remove('inactive');
                dot.classList.add('active');
            } else {
                dot.classList.add('inactive');
                dot.classList.remove('active');
            }
        });
        
        // Update mode label
        const modeLabel = document.getElementById('timer-mode-label');
        if (modeLabel) {
            modeLabel.textContent = document.body.dataset.modoMode === 'break' ? 'BREAK_SEQUENCE' : 'FOCUS_EXECUTION';
        }
    });
</script>
{% endblock %}
