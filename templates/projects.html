{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto" x-data="{ createModalOpen: false }">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Projects</h1>
        <button @click="createModalOpen = true" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            New Project
        </button>
    </div>

    {% if pending_invites %}
    <div class="mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Pending Invites</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for invite in pending_invites %}
            <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-indigo-900 dark:text-indigo-100 mb-1">{{ invite.project.name }}</h3>
                <p class="text-sm text-indigo-700 dark:text-indigo-300 mb-4">Invited by {{ invite.sender.username }}</p>
                <div class="flex gap-2">
                    <form action="{{ url_for('projects.respond_project_invite', invite_id=invite.id, action='accept') }}" method="POST" class="flex-1">
                        <button class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">Accept</button>
                    </form>
                    <form action="{{ url_for('projects.respond_project_invite', invite_id=invite.id, action='decline') }}" method="POST" class="flex-1">
                        <button class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition">Decline</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for project in projects %}
        <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="block bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-md transition border border-gray-100 dark:border-gray-700 group">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 group-hover:text-indigo-600 transition">{{ project.name }}</h2>
                <span class="text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2.5 py-1 rounded-full">{{ project.members|length }} members</span>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-6 line-clamp-2 h-10">
                {{ project.description or 'No description provided.' }}
            </p>
            <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50 dark:border-gray-700">
                <div class="flex -space-x-2">
                    {% for member in project.members[:3] %}
                    <div class="w-8 h-8 rounded-full border-2 border-white dark:border-gray-800 bg-indigo-100 flex items-center justify-center text-[10px] font-bold text-indigo-700" title="{{ member.user.username }}">
                        {{ member.user.username[:2]|upper }}
                    </div>
                    {% endfor %}
                    {% if project.members|length > 3 %}
                    <div class="w-8 h-8 rounded-full border-2 border-white dark:border-gray-800 bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600">
                        +{{ project.members|length - 3 }}
                    </div>
                    {% endif %}
                </div>
                <span class="text-xs text-gray-400">{{ project.created_at.strftime('%b %d, %Y') }}</span>
            </div>
        </a>
        {% else %}
        <div class="col-span-full py-20 text-center bg-white dark:bg-gray-800 rounded-xl border-2 border-dashed border-gray-200 dark:border-gray-700">
            <svg class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
            <h3 class="text-xl font-medium text-gray-900 dark:text-gray-100">No projects yet</h3>
            <p class="text-gray-500 dark:text-gray-400 mt-2 mb-6">Create a project to start collaborating with others.</p>
            <button @click="createModalOpen = true" class="text-indigo-600 hover:text-indigo-800 font-bold transition">Create your first project &rarr;</button>
        </div>
        {% endfor %}
    </div>

    <!-- Create Project Modal -->
    <div x-show="createModalOpen" 
         class="fixed inset-0 z-[100] overflow-y-auto" 
         style="display: none;"
         @keydown.escape.window="createModalOpen = false">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="createModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="createModalOpen = false"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div x-show="createModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-gray-800 rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <form action="{{ url_for('projects.create_project') }}" method="POST">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project Name</label>
                        <input type="text" name="name" id="name" required class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Website Redesign">
                    </div>
                    <div class="mb-6">
                        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description (Optional)</label>
                        <textarea name="description" id="description" rows="3" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="What is this project about?"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" @click="createModalOpen = false" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">Create Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize modal state from alpine in base if needed, or just local
    document.addEventListener('alpine:init', () => {
        // We can use a global store or just keep it local to the content block
    });
</script>
{% endblock %}
