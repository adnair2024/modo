{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-12" x-data="{ sectionModalOpen: false, inviteModalOpen: false, taskModalOpen: false, activeSectionId: null }">
    
    <!-- Header: Terminal Style -->
    <div class="flex flex-col md:flex-row justify-between items-baseline border-b noir-border pb-4 gap-4">
        <div class="space-y-1">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('projects.projects_list') }}" class="text-accent hover:scale-110 transition-transform">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </a>
                <h1 class="text-4xl font-bold tracking-tighter mono-display uppercase">{{ project.name }}</h1>
            </div>
            <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest ml-10">MANIFEST: {{ project.description or 'GENERAL_COLLABORATION_PROTOCOL' }}</p>
        </div>
        
        <div class="flex items-center gap-4 ml-10 md:ml-0">
            {% if project.owner_id == current_user.id %}
            <button @click="inviteModalOpen = true" class="noir-button-outline text-[10px] px-4 py-1.5">SIGNAL_INVITE</button>
            {% endif %}
            <button @click="sectionModalOpen = true" class="noir-button text-[10px] px-4 py-1.5">NEW_SECTOR</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- Main Board: Noir Grid -->
        <div class="lg:col-span-9" x-data="{ 
            initSortable() {
                if(typeof Sortable !== 'undefined') {
                    document.querySelectorAll('.task-list').forEach(el => {
                        new Sortable(el, {
                            group: 'tasks',
                            animation: 0,
                            ghostClass: 'opacity-20',
                            onEnd: (evt) => {
                                const taskId = evt.item.id.replace('task-', '');
                                const sectionId = evt.to.getAttribute('data-section-id');
                                const formData = new FormData();
                                formData.append('section_id', sectionId);
                                fetch(`/projects/tasks/${taskId}/move`, { method: 'POST', body: formData });
                            }
                        });
                    });
                }
            }
        }" x-init="setTimeout(() => initSortable(), 100)">
            
            <div class="flex gap-8 overflow-x-auto pb-12 snap-x custom-scrollbar">
                {% for section in project.sections %}
                <div class="flex-shrink-0 w-80 snap-start space-y-6">
                    <!-- Section Header -->
                    <div class="flex justify-between items-center group noir-border border-b-4 border-b-black dark:border-b-white p-3 bg-[var(--bg-alt)]" x-data="{ editing: false, name: '{{ section.name }}' }">
                        <div class="flex-1 min-w-0">
                            <template x-if="!editing">
                                <h3 @dblclick="editing = true" class="text-xs font-bold uppercase tracking-widest truncate cursor-pointer hover:text-accent">
                                    <span x-text="name"></span>
                                    <span class="opacity-30 ml-2">[{{ section.tasks|length }}]</span>
                                </h3>
                            </template>
                            <template x-if="editing">
                                <form @submit.prevent="
                                    const formData = new FormData();
                                    formData.append('name', name);
                                    fetch('{{ url_for('projects.edit_project_section', section_id=section.id) }}', { method: 'POST', body: formData }).then(() => editing = false);
                                ">
                                    <input x-model="name" @keydown.escape="editing = false" @click.away="editing = false" 
                                           class="noir-input w-full text-[10px] font-bold uppercase py-0" x-init="$el.focus()">
                                </form>
                            </template>
                        </div>
                        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click="activeSectionId = {{ section.id }}; taskModalOpen = true" class="text-accent hover:scale-110">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                            {% if project.owner_id == current_user.id %}
                            <form action="{{ url_for('projects.delete_project_section', section_id=section.id) }}" method="POST" x-data="{}" @submit.prevent="if(await window.modoConfirm(\'ERASE_SECTOR_DATA?\')) .submit()">
                                <button type="submit" class="text-red-600 hover:scale-110">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Task List Container -->
                    <div class="space-y-4 min-h-[200px] task-list" data-section-id="{{ section.id }}">
                        {% for task in section.tasks %}
                            {% include 'partials/task_item.html' %}
                        {% endfor %}
                    </div>
                    
                    <button @click="activeSectionId = {{ section.id }}; taskModalOpen = true" 
                            class="w-full py-4 noir-border border-dashed opacity-30 hover:opacity-100 hover:border-accent hover:text-accent transition-all text-[10px] font-bold uppercase tracking-widest bg-[var(--bg-alt)]">
                        + APPEND_RECORD
                    </button>
                </div>
                {% else %}
                <div class="w-full py-32 text-center noir-border border-dashed opacity-30">
                    <span class="text-xs font-bold uppercase tracking-widest">NO_SECTORS_ALLOCATED // BOARD_OFFLINE</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar: Hardware Info -->
        <div class="lg:col-span-3 space-y-12">
            <!-- Members Matrix -->
            <section class="space-y-6">
                <div class="flex flex-col items-center w-full border-b noir-border border-opacity-10 pt-6 pb-4">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-accent text-center">Active_Nodes</h3>
                    <span class="text-[10px] font-bold opacity-30 tracking-widest text-center mt-1">{{ project.members|length }}/06</span>
                </div>
                <div class="space-y-6">
                    {% for member in project.members %}
                    <div class="flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="w-8 h-8 bg-accent/10 flex items-center justify-center text-[10px] font-bold">
                                {{ member.user.username[0]|upper }}
                            </div>
                            <div class="space-y-1">
                                <p class="text-sm font-bold uppercase tracking-tight">{{ member.user.username }}</p>
                                <p class="text-[10px] opacity-40 uppercase font-bold tracking-widest">{{ member.role }}</p>
                            </div>
                        </div>
                        {% if project.owner_id == current_user.id and member.user_id != current_user.id %}
                        <form action="{{ url_for('projects.kick_project_member', project_id=project.id, user_id=member.user_id) }}" method="POST" x-data="{}" @submit.prevent="if(await window.modoConfirm(\'EJECT_NODE?\')) .submit()">
                            <button type="submit" class="text-red-600 opacity-0 group-hover:opacity-100 hover:scale-110 transition-all p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Activity Stream -->
            <section class="space-y-6">
                <div class="flex flex-col items-center w-full border-b noir-border border-opacity-10 pt-6 pb-4">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-accent text-center">Event_Stream</h3>
                </div>
                <div class="space-y-8 max-h-[600px] overflow-y-auto pr-4 custom-scrollbar">
                    {% for activity in project.activities %}
                    <div class="space-y-2 border-l-2 border-accent border-opacity-10 pl-4">
                        <p class="text-[11px] font-bold leading-tight uppercase tracking-wide">
                            <span class="text-accent opacity-80">@{{ activity.user.username }}</span> 
                            <span class="opacity-80">{{ activity.action }}</span>
                        </p>
                        <p class="text-[9px] opacity-30 font-bold uppercase tracking-[0.2em]">{{ activity.timestamp.strftime('%H:%M // %Y.%m.%d') }}</p>
                    </div>
                    {% else %}
                    <p class="text-xs font-bold opacity-30 uppercase text-center py-12 italic tracking-[0.3em]">STREAM_IDLE</p>
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div x-show="sectionModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" style="display: none;" x-cloak>
        <div @click.away="sectionModalOpen = false" class="max-w-md w-full noir-border bg-[var(--bg-alt)] p-10 space-y-8">
            <h3 class="text-xl font-bold mono-display uppercase border-b noir-border pb-4">Alloc_New_Sector</h3>
            <form action="{{ url_for('projects.add_project_section', project_id=project.id) }}" method="POST" class="space-y-8">
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold opacity-50 uppercase tracking-widest">Sector_Identifier</label>
                    <input type="text" name="name" required class="noir-input w-full font-bold" placeholder="NAME_INPUT_">
                </div>
                <div class="flex gap-4">
                    <button type="button" @click="sectionModalOpen = false" class="noir-button-outline flex-1 py-3 text-xs">ABORT</button>
                    <button type="submit" class="noir-button flex-1 py-3 text-xs">CONFIRM</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div x-show="taskModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" style="display: none;" x-cloak>
        <div @click.away="taskModalOpen = false" class="max-w-lg w-full noir-border bg-[var(--bg-alt)] p-10 space-y-8">
            <h3 class="text-xl font-bold mono-display uppercase border-b noir-border pb-4">Append_Task_Record</h3>
            <form :action="'/projects/sections/' + activeSectionId + '/tasks'" method="POST" class="space-y-6">
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold opacity-50 uppercase">Record_Title</label>
                        <input type="text" name="title" required class="noir-input w-full font-bold" placeholder="TITLE_INPUT_">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold opacity-50 uppercase">Manifest_Data</label>
                        <textarea name="description" rows="3" class="noir-input w-full text-xs resize-none" placeholder="SUPPLEMENTAL_INFO_"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-[10px] font-bold opacity-50 uppercase">Priority</label>
                            <select name="priority" class="noir-input w-full text-xs bg-transparent font-bold">
                                <option value="1">L_01 (LOW)</option>
                                <option value="2">L_02 (MED)</option>
                                <option value="3">L_03 (HIGH)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[10px] font-bold opacity-50 uppercase">Deadline</label>
                            <input type="datetime-local" name="due_date" class="noir-input w-full text-[10px]">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" @click="taskModalOpen = false" class="noir-button-outline flex-1 py-3 text-xs">ABORT</button>
                    <button type="submit" class="noir-button flex-1 py-3 text-xs">COMMIT</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Modal -->
    <div x-show="inviteModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" style="display: none;" x-cloak>
        <div @click.away="inviteModalOpen = false" class="max-w-md w-full noir-border bg-[var(--bg-alt)] p-10 space-y-8"
             x-data="{ inviteUsername: '', inviteMsg: '', inviteError: '' }">
            <h3 class="text-xl font-bold mono-display uppercase border-b noir-border pb-4">Collaborator_Invite</h3>
            
            <div x-show="inviteMsg" class="p-3 noir-border border-accent text-accent text-[10px] font-bold uppercase" x-text="inviteMsg"></div>
            <div x-show="inviteError" class="p-3 noir-border border-red-600 text-red-600 text-[10px] font-bold uppercase" x-text="inviteError"></div>

            <form @submit.prevent="
                const formData = new FormData();
                formData.append('username', inviteUsername);
                fetch('{{ url_for('projects.invite_to_project', project_id=project.id) }}', { method: 'POST', body: formData })
                .then(r => r.json()).then(data => {
                    if (data.error) { inviteError = data.error; inviteMsg = ''; }
                    else { inviteMsg = data.message; inviteError = ''; inviteUsername = ''; setTimeout(() => { inviteModalOpen = false; inviteMsg = ''; }, 2000); }
                })
            " class="space-y-8">
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold opacity-50 uppercase">Target_UID</label>
                    <input type="text" x-model="inviteUsername" required class="noir-input w-full font-bold" placeholder="UID_SCAN_">
                </div>
                <div class="flex gap-4">
                    <button type="button" @click="inviteModalOpen = false" class="noir-button-outline flex-1 py-3 text-xs">ABORT</button>
                    <button type="submit" class="noir-button flex-1 py-3 text-xs">SEND_SIGNAL</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
